# [User Guide] Device Mapper Proxy

[English guide available here](./README.md)

---

## Установка и тестирование модуля
### Шаг 0: Подготовка

Этот модуль разработан и тестировался в **Fedora 33**.  
Использовалось ядро `Linux 5.9.8-200.fc33.x86_64`  

Для успешной компиляции модуля необходим установленный `gcc` и
`make`. Их можно установаить с помощью `dnf install gcc make`. 

Также *необходимы заголовочные файлы ядра нужной версии*. В Fedora их
можно получить установив пакет `kernel-devel`. Установка производится 
с помощью  `dnf install kernel-devel`.

### Шаг 1: Компиляция
Склонируйте репозиторий и перейдите в директорию проекта. 
Используйте команду `make` чтобы собрать модуль:

```
    $ make
```

### Шаг 2: Установка
С помощью команды `insmod` установите модуль в ядро.
В этом и следующих шагах нужны права суперпользователя, используйте
`sudo` или переключитесь на пользователя root с помощью `su`.

```
    $ su
    $ insmod device_mapper_proxy.ko
```

Если во время установки происходит сбой, то с помощью 
`journalctl` или `dmesg` возможно просмотреть лог ошибок модуля.

Проверить что модуль установлен можно с помощью `lsmod`: 
```
    $ lsmod | grep "device_mapper_proxy"
```

### Шаг 3: Тестирование модуля
Для удобства можно создать переменную size, задающую размер 
блочного устройства в секторах:

```
	$ size=20000
```

Создание тестового блочного устройства:
```
    $ dmsetup create zero1 --table "0 $size zero"
```

Создание proxy-устройства:
```
    $ dmsetup create dmp1 --table "0 $size dmp /dev/mapper/zero1"
```

С помощью команды `ls` можно проверить что устройства создались:
```
    $ ls -al /dev/mapper
```

С помощью утилиты `dd` проведем операции записи и чтения:
```
    $ dd if=/dev/random of=/dev/mapper/dmp1 bs=4k count=1
    $ dd of=/dev/null if=/dev/mapper/dmp1 bs=4k count=1
```

В sysfs модуля доступна статистика:
```
	$ cat /sys/module/device_mapper_proxy/stat/volumes
```

Пример статистики:
```
read:
 reqs: 549
 avg size: 916
write:
 reqs: 8
 avg size: 512
total:
 reqs: 557
 avg size: 916
```

Можно сравнить статистику I/O запросов 
(количество операций чтения и записи должны совпадать):
```
    $ cat /sys/block/dm-1/stat
```
